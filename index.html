<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>Velox Browser - Mac-szerű gombokkal</title>
  <!-- Font Awesome ikonok (CDN) -->
  <link 
    rel="stylesheet" 
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" 
    integrity="sha512-acEz2XKUp5AdCW6+SKbM1lkhGASv3ZjPY56H3Zc1SQ/Yw0Rx6snVMvETNxa+KDHcy2CsEVx/v+HrlAf7HfaX9A==" 
    crossorigin="anonymous" 
    referrerpolicy="no-referrer" 
  />

  <style>
    /* Alap stílus */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      user-select: none; 
      font-family: sans-serif;
    }
    html, body {
      width: 100%;
      height: 100%;
      background-color: #1e1e1e;
      color: #fff;
      overflow: hidden; /* eltünteti a görgetősávot az ablakon */
    }

    .browser-container {
      display: flex;
      flex-direction: column;
      width: 100%;
      height: 100%;
    }

    /* Mac-szerű titlebar */
    .titlebar {
      height: 30px;
      background: #2c2c2c;
      display: flex;
      align-items: center;
      position: relative;
    }
    /* 3 kör bal oldalt: piros, sárga, zöld */
    .mac-buttons {
      display: flex;
      gap: 8px;
      padding: 0 12px;
      align-items: center;
      position: absolute;
      left: 0;
      height: 30px;
    }
    .mac-btn {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      cursor: pointer;
      margin-top: 9px; /* kissé lejjebb a kör közepe */
    }
    .mac-btn.red { background: #ff5f57; }
    .mac-btn.yellow { background: #ffbd2e; }
    .mac-btn.green { background: #28c940; }

    /* A címsor többi része "drag" terület */
    .drag-region {
      flex: 1;
      -webkit-app-region: drag;
    }

    /* Belső rész: oldalsáv + jobb oldali content */
    .browser-layout {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* Sidebar */
    .sidebar {
      width: 70px;
      background: #2c2c2c;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      transition: width 0.3s;
    }
    .sidebar:hover {
      width: 200px;
    }
    .sidebar-top, .sidebar-bottom {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 10px;
    }
    .sidebar-item {
      width: 100%;
      color: #bbb;
      padding: 8px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      transition: background 0.2s;
    }
    .sidebar-item i {
      margin-right: 10px;
    }
    .sidebar-item:hover {
      background: #444;
    }
    .sidebar-item span {
      display: none; /* oldalsáv keskeny állapotában */
    }
    .sidebar:hover .sidebar-item span {
      display: inline; /* bővített állapotban */
    }

    /* Tablista a sidebar közepén */
    .tab-list {
      flex: 1;
      width: 100%;
      overflow-y: auto;
      margin-top: 10px;
    }
    .tab-item {
      margin: 4px 10px;
      background: #3b3b3b;
      padding: 6px;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #ddd;
      cursor: pointer;
    }
    .tab-item.active {
      background: #555;
    }

    /* Jobb oldali content: topbar + webview(k) */
    .content-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #1e1e1e;
    }

    /* Felső sáv a navigációhoz */
    .topbar {
      height: 50px;
      background: #2c2c2c;
      display: flex;
      align-items: center;
      padding: 0 10px;
      gap: 10px;
    }
    .nav-buttons button {
      width: 40px;
      height: 35px;
      border: none;
      background: #3b3b3b;
      color: #ccc;
      cursor: pointer;
      border-radius: 4px;
      font-size: 14px;
    }
    .nav-buttons button:hover {
      background: #555;
    }
    .url-bar {
      flex: 1;
      height: 35px;
      background: #3b3b3b;
      border: none;
      border-radius: 4px;
      color: #ccc;
      padding: 0 10px;
      outline: none;
    }

    .webview-container {
      position: relative;
      flex: 1;
      background: #1e1e1e;
    }
    webview {
      width: 100%;
      height: 100%;
      border: none;
      display: none; /* Alapban rejtve, az aktív fül mutatjuk */
    }

    /* ---- Bővítménykeresés UI (példa) ---- */
    .extension-search-container {
      background: #3b3b3b;
      padding: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .extension-search-container input {
      flex: 1;
      height: 30px;
      border-radius: 4px;
      border: none;
      outline: none;
      padding: 0 8px;
    }
    .extension-search-container button {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      background: #555;
      color: #fff;
      cursor: pointer;
    }
    .extension-results {
      padding: 8px;
      background: #2c2c2c;
    }
    .extension-item {
      margin-bottom: 6px;
      border-bottom: 1px solid #444;
      padding-bottom: 6px;
    }
    .extension-item .install-link {
      color: #09f;
      cursor: pointer;
      margin-left: 8px;
    }

  </style>
</head>
<body>
<div class="browser-container">

  <!-- Titlebar: Mac-szerű piros/sárga/zöld gombok balra -->
  <div class="titlebar">
    <div class="mac-buttons">
      <div class="mac-btn red" onclick="handleWindowControl('close')"></div>
      <div class="mac-btn yellow" onclick="handleWindowControl('minimize')"></div>
      <div class="mac-btn green" onclick="handleWindowControl('maximize')"></div>
    </div>
    <div class="drag-region"></div>
  </div>

  <!-- Belső elrendezés (sidebar + jobb content) -->
  <div class="browser-layout">
    <div class="sidebar">
      <div class="sidebar-top">
        <div class="sidebar-item" onclick="openNewTab()">
          <i class="fas fa-plus"></i><span>Új fül</span>
        </div>
        <div class="sidebar-item" onclick="openBookmarks()">
          <i class="fas fa-star"></i><span>Kedvencek</span>
        </div>
        <div class="sidebar-item" onclick="openHistory()">
          <i class="fas fa-history"></i><span>Előzmények</span>
        </div>
      </div>
      
      <div class="tab-list" id="tabList"></div>

      <div class="sidebar-bottom">
        <div class="sidebar-item" onclick="pickAndInstallExtension()">
          <i class="fas fa-puzzle-piece"></i><span>Bővítm. telep.</span>
        </div>
      </div>
    </div>

    <div class="content-panel">
      <!-- Bővítménykereső sáv -->
      <div class="extension-search-container">
        <input 
          type="text" 
          id="extensionSearchInput" 
          placeholder="Bővítmény keresése pl. 'React' "
        />
        <button onclick="searchExtensions()">Keresés</button>
      </div>
      <div class="extension-results" id="extensionResults"></div>

      <!-- Topbar: vissza/előre/újratöltés, URL mező -->
      <div class="topbar">
        <div class="nav-buttons">
          <button id="backBtn"><i class="fas fa-arrow-left"></i></button>
          <button id="forwardBtn"><i class="fas fa-arrow-right"></i></button>
          <button id="reloadBtn"><i class="fas fa-redo"></i></button>
        </div>
        <input type="text" class="url-bar" id="urlBar" placeholder="Írj be egy URL-t..." />
      </div>

      <!-- Webview-ek tartománya -->
      <div class="webview-container" id="webviewContainer"></div>
    </div>
  </div>
</div>

<script>
  /* Itt, DEMÓ-ban, nodeIntegration: true => require() hívható */
  const { ipcRenderer } = require('electron');

  /* Globális adatok */
  let tabs = []; // {id, title, url, webviewEl, isActive}
  let currentTabId = null;

  let historyList = [];
  let bookmarks = [];

  /* DOM referenciák */
  const tabListEl = document.getElementById("tabList");
  const webviewContainerEl = document.getElementById("webviewContainer");

  const backBtn = document.getElementById("backBtn");
  const forwardBtn = document.getElementById("forwardBtn");
  const reloadBtn = document.getElementById("reloadBtn");
  const urlBar = document.getElementById("urlBar");

  const extensionSearchInput = document.getElementById("extensionSearchInput");
  const extensionResultsEl = document.getElementById("extensionResults");

  /* --- Ablakvezérlés (macOS gombok) --- */
  function handleWindowControl(action) {
    ipcRenderer.invoke('windowControl', action);
  }

  /* --- Fülek --- */
  function openNewTab() {
    const tabId = Date.now().toString();
    const defaultUrl = "https://www.google.com";

    const webview = document.createElement("webview");
    webview.src = defaultUrl;
    webview.setAttribute("allowpopups", "true");
    webview.style.display = "none";
    webviewContainerEl.appendChild(webview);

    const newTab = {
      id: tabId,
      title: "Új fül",
      url: defaultUrl,
      webviewEl: webview,
      isActive: false
    };
    tabs.push(newTab);

    webview.addEventListener("page-title-updated", (e) => {
      newTab.title = e.title;
      updateTabListUI();
    });
    webview.addEventListener("did-stop-loading", () => {
      newTab.url = webview.getURL();
      urlBar.value = newTab.url;
      // Előzményhez
      historyList.push({
        url: newTab.url,
        title: newTab.title,
        time: new Date()
      });
    });

    setActiveTab(tabId);
  }

  function setActiveTab(tabId) {
    // Az előző aktív fül rejtése
    if (currentTabId) {
      const oldTab = tabs.find(t => t.id === currentTabId);
      if (oldTab) {
        oldTab.isActive = false;
        oldTab.webviewEl.style.display = "none";
      }
    }
    // Új fül látható
    const newTab = tabs.find(t => t.id === tabId);
    if (newTab) {
      newTab.isActive = true;
      newTab.webviewEl.style.display = "block";
      currentTabId = newTab.id;
      urlBar.value = newTab.url || "";
    }
    updateTabListUI();
  }

  function closeTab(tabId) {
    const idx = tabs.findIndex(t => t.id === tabId);
    if (idx !== -1) {
      const closingTab = tabs[idx];
      webviewContainerEl.removeChild(closingTab.webviewEl);
      tabs.splice(idx, 1);

      if (closingTab.id === currentTabId) {
        if (tabs.length > 0) {
          setActiveTab(tabs[tabs.length - 1].id);
        } else {
          currentTabId = null;
          urlBar.value = "";
        }
      }
    }
    updateTabListUI();
  }

  function updateTabListUI() {
    tabListEl.innerHTML = "";
    tabs.forEach(tab => {
      const tabItem = document.createElement("div");
      tabItem.classList.add("tab-item");
      if (tab.isActive) {
        tabItem.classList.add("active");
      }
      const shortTitle = tab.title.length > 12 
        ? tab.title.slice(0,12)+"..." 
        : tab.title;
      tabItem.innerHTML = `
        <span>${shortTitle}</span>
        <i class="fas fa-times" style="margin-left:8px;"></i>
      `;
      tabItem.addEventListener("click", () => setActiveTab(tab.id));
      // Bezárás gomb
      const closeIcon = tabItem.querySelector(".fa-times");
      closeIcon.addEventListener("click", (e) => {
        e.stopPropagation();
        closeTab(tab.id);
      });
      tabListEl.appendChild(tabItem);
    });
  }

  function getCurrentTab() {
    return tabs.find(t => t.id === currentTabId);
  }

  /* --- Navigációs gombok --- */
  backBtn.addEventListener("click", () => {
    const tab = getCurrentTab();
    if (tab?.webviewEl.canGoBack()) {
      tab.webviewEl.goBack();
    }
  });
  forwardBtn.addEventListener("click", () => {
    const tab = getCurrentTab();
    if (tab?.webviewEl.canGoForward()) {
      tab.webviewEl.goForward();
    }
  });
  reloadBtn.addEventListener("click", () => {
    const tab = getCurrentTab();
    if (tab) {
      tab.webviewEl.reload();
    }
  });

  // URL sáv: Enterre betölt
  urlBar.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      const newUrl = normalizeUrl(urlBar.value);
      navigateTo(newUrl, currentTabId);
    }
  });
  function navigateTo(url, tabId) {
    const tab = tabs.find(t => t.id === tabId);
    if (tab) {
      tab.webviewEl.loadURL(url);
    }
  }
  function normalizeUrl(input) {
    if (!/^https?:\/\//i.test(input)) {
      return "https://" + input;
    }
    return input;
  }

  /* --- Előzmények, könyvjelzők, bővítmények --- */
  function openHistory() {
    let msg = "Előzmények (utolsó 5):\n";
    historyList.slice(-5).forEach(h => {
      msg += `${h.time.toLocaleTimeString()} - ${h.title} [${h.url}]\n`;
    });
    alert(msg);
  }
  function openBookmarks() {
    let msg = "Könyvjelzők:\n";
    bookmarks.forEach(b => {
      msg += `${b.title} - ${b.url}\n`;
    });
    alert(msg);
  }

  // 1) Megkérjük a usert, válasszon egy mappát
  // 2) Betöltjük a kiválasztott extensiont
  async function pickAndInstallExtension() {
    const dir = await ipcRenderer.invoke('pickExtensionDirectory');
    if (!dir) {
      alert("Nincs mappa kiválasztva vagy megszakítva.");
      return;
    }
    // Telepítés:
    const result = await ipcRenderer.invoke('installExtension', dir);
    if (result.success) {
      alert(`Sikeresen telepítve: ${result.name}`);
    } else {
      alert(`Hiba: ${result.error}`);
    }
  }

  /* --- Bővítmény keresés --- */
  async function searchExtensions() {
    const query = extensionSearchInput.value.trim();
    if (!query) {
      extensionResultsEl.innerHTML = "<i>Nincs beírt keresőszó</i>";
      return;
    }
    const results = await ipcRenderer.invoke('searchExtensions', query);
    if (!results || results.length === 0) {
      extensionResultsEl.innerHTML = "<i>Nincs találat</i>";
      return;
    }
    let html = "";
    results.forEach(r => {
      html += `
        <div class="extension-item">
          <b>${r.name}</b> - ${r.description}
          <span 
            class="install-link"
            onclick="fakeInstall('${r.name}')"
          >
            [Install]
          </span>
        </div>
      `;
    });
    extensionResultsEl.innerHTML = html;
  }
  function fakeInstall(extName) {
    alert(`(Demo) Telepítve: ${extName}`);
  }

  /* Induláskor nyissunk 1 lapot */
  window.addEventListener('DOMContentLoaded', () => {
    openNewTab();
  });
</script>
</body>
</html>
